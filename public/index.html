Opportunity</th><th class="text-center p-4">Intent</th><th class="text-center p-4">Action</th></tr></thead><tbody>${d.slice(0,100).map(k=>`<tr class="table-row border-b border-slate-700/50"><td class="p-4 font-medium">${esc(k.keyword)}</td><td class="text-right p-4">${fmt(k.searchVolume)}</td><td class="text-right p-4"><span class="${k.cpc<3?'text-emerald-400':k.cpc<10?'text-amber-400':'text-rose-400'} font-medium">$${k.cpc?.toFixed(2)}</span></td><td class="text-center p-4"><span class="px-2 py-1 rounded-lg text-xs ${k.difficulty==='Easy'?'bg-emerald-500/20 text-emerald-400':k.difficulty==='Medium'?'bg-amber-500/20 text-amber-400':'bg-rose-500/20 text-rose-400'}">${k.difficulty}</span></td><td class="text-center p-4"><div class="flex items-center justify-center gap-1"><div class="w-12 h-2 rounded bg-slate-700"><div class="h-full rounded ${k.opportunityScore>=60?'bg-emerald-500':k.opportunityScore>=40?'bg-amber-500':'bg-rose-500'}" style="width:${k.opportunityScore}%"></div></div><span class="text-xs ${k.opportunityScore>=60?'text-emerald-400':'text-slate-400'}">${k.opportunityScore}</span></div></td><td class="text-center p-4"><span class="px-2 py-1 rounded-lg text-xs ${k.intent==='Commercial'||k.intent==='Transactional'?'bg-purple-500/20 text-purple-400':'bg-slate-500/20 text-slate-400'}">${k.intent}</span></td><td class="text-center p-4"><button onclick="addKeyword('${esc(k.keyword)}')" class="px-3 py-1 rounded-lg text-xs bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">+ Add</button></td></tr>`).join('')}</tbody></table>`;}

function filterKeywords(t){let f=[...keywordData];if(t==='opportunities')f=f.filter(k=>k.opportunityScore>=60).sort((a,b)=>b.opportunityScore-a.opportunityScore);else if(t==='lowcpc')f=f.filter(k=>k.cpc<5).sort((a,b)=>a.cpc-b.cpc);else if(t==='highvolume')f=f.sort((a,b)=>b.searchVolume-a.searchVolume);renderKeywordTable(f);}
function addKeyword(k){showAlert(`Added "${k}" to list`,'success');}

async function sendChat(){const inp=document.getElementById('chatInput'),m=inp.value.trim();if(!m||isTyping)return;const ck=getApiKey('claude');if(!ck){showAlert('Add Claude API key in Settings','error');showPage('settings');return;}addMessageToChat('user',m);inp.value='';isTyping=true;document.getElementById('sendBtn').disabled=true;document.getElementById('aiStatus').textContent='Thinking...';document.getElementById('aiStatus').className='px-2 py-0.5 rounded-full text-xs bg-purple-500/20 text-purple-400 animate-pulse';const c=document.getElementById('chatMessages'),id='ai-'+Date.now();c.insertAdjacentHTML('beforeend',`<div class="flex gap-3"><div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div><div class="bg-slate-700/50 rounded-xl rounded-tl-none p-4 max-w-2xl"><div id="${id}" class="ai-message text-sm"></div></div></div>`);c.scrollTop=c.scrollHeight;
try{const r=await fetch('/ai/chat/stream',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m,claudeApiKey:ck})});const rd=r.body.getReader(),dc=new TextDecoder();let txt='';while(true){const{value,done}=await rd.read();if(done)break;const ch=dc.decode(value);for(const ln of ch.split('\n')){if(ln.startsWith('data: ')){try{const d=JSON.parse(ln.slice(6));if(d.type==='chunk'){txt+=d.text;document.getElementById(id).innerHTML=marked.parse(txt)+'<span class="typing-cursor">â–Š</span>';c.scrollTop=c.scrollHeight;}else if(d.type==='done')document.getElementById(id).innerHTML=marked.parse(txt);}catch(e){}}}}}catch(e){document.getElementById(id).innerHTML='<span class="text-rose-400">Error: '+e.message+'</span>';}isTyping=false;document.getElementById('sendBtn').disabled=false;document.getElementById('aiStatus').textContent='Ready';document.getElementById('aiStatus').className='px-2 py-0.5 rounded-full text-xs bg-emerald-500/20 text-emerald-400';}

function addMessageToChat(r,t){const c=document.getElementById('chatMessages'),u=r==='user';c.insertAdjacentHTML('beforeend',`<div class="flex gap-3 ${u?'justify-end':''}"><div class="${u?'bg-blue-500/20 rounded-xl rounded-tr-none':'bg-slate-700/50 rounded-xl rounded-tl-none'} p-4 max-w-2xl"><div class="text-sm">${esc(t)}</div></div>${u?'<div class="w-8 h-8 rounded-lg bg-slate-700 flex items-center justify-center flex-shrink-0"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></div>':''}</div>`);c.scrollTop=c.scrollHeight;}
function quickPrompt(p){document.getElementById('chatInput').value=p;sendChat();}
function clearChat(){document.getElementById('chatMessages').innerHTML='<div class="flex gap-3"><div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div><div class="bg-slate-700/50 rounded-xl rounded-tl-none p-4 max-w-2xl"><p class="text-sm">Chat cleared. How can I help you?</p></div></div>';}

function loadDashboard(){fetch('/api/dashboard').then(r=>r.json()).then(d=>{document.getElementById('totalImpressions').textContent=fmt(d.impressions||0);document.getElementById('totalClicks').textContent=fmt(d.clicks||0);document.getElementById('totalConversions').textContent=fmt(d.conversions||0);document.getElementById('totalCost').textContent='$'+fmt(d.cost||0);initChart();}).catch(()=>initChart());}
function initChart(){const ctx=document.getElementById('performanceChart');if(ctx&&!ctx.chart){ctx.chart=new Chart(ctx,{type:'line',data:{labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],datasets:[{label:'Clicks',data:[120,150,180,140,200,170,190],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#1e293b'},ticks:{color:'#64748b'}},y:{grid:{color:'#1e293b'},ticks:{color:'#64748b'}}}}});}}

function fmt(n){if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n?.toLocaleString()||'0';}
function esc(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML;}
function showAlert(m,t='info'){const c={success:'bg-emerald-500/20 border-emerald-500/50 text-emerald-400',error:'bg-rose-500/20 border-rose-500/50 text-rose-400',info:'bg-blue-500/20 border-blue-500/50 text-blue-400'};document.getElementById('alertContainer').innerHTML=`<div class="p-4 rounded-xl border ${c[t]} mb-4">${m}</div>`;setTimeout(()=>document.getElementById('alertContainer').innerHTML='',5000);}
function refreshData(){loadDashboard();}
function sortCompetitorKeywords(){renderCompetitorKeywords();}
function exportKeywords(){showAlert('Exporting...','info');}

document.addEventListener('DOMContentLoaded',checkAuth);
</script>
</body>
</html>
