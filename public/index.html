<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AdsPro - Google Ads Manager</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{font-family:'Inter',sans-serif}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:#1e293b}
::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
.glass{backdrop-filter:blur(10px)}
.stat-card:hover{transform:scale(1.02)}
.nav-item.active{background:linear-gradient(135deg,#3b82f6,#8b5cf6);box-shadow:0 4px 15px rgba(59,130,246,0.4)}
.table-row:hover{background:rgba(59,130,246,0.1)}
.loading{opacity:0.5;pointer-events:none}
.spinner{border:3px solid #334155;border-top:3px solid #3b82f6;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body class="bg-slate-900 text-white min-h-screen">

<!-- Login Screen -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center">
<div class="bg-slate-800 border border-slate-700 rounded-2xl p-8 max-w-md w-full mx-4 text-center">
<div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center mx-auto mb-6">
<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
</div>
<h1 class="text-2xl font-bold mb-2">AdsPro</h1>
<p class="text-slate-400 mb-6">Professional Google Ads Management Tool</p>

<div id="loginContent">
<p class="text-sm text-slate-400 mb-6">Connect your Google Ads account to view and manage your campaigns, keywords, and performance data.</p>
<a href="/auth/login" class="inline-flex items-center justify-center gap-3 px-6 py-3 rounded-xl bg-white text-slate-900 font-medium hover:bg-slate-100 transition-colors w-full">
<svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
Sign in with Google
</a>
</div>

<div id="loginError" class="hidden mt-4 p-3 rounded-lg bg-rose-500/20 text-rose-400 text-sm"></div>
</div>
</div>

<!-- Main App -->
<div id="app" class="hidden">
<div class="flex">
<!-- Sidebar -->
<aside class="w-60 h-screen bg-slate-800/90 border-r border-slate-700/50 fixed left-0 top-0 glass z-50 flex flex-col">
<div class="p-5 border-b border-slate-700/50">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
</div>
<div>
<h1 class="font-bold text-lg">AdsPro</h1>
<p class="text-xs text-slate-400">Google Ads Manager</p>
</div>
</div>
</div>

<nav class="flex-1 p-4 space-y-1">
<button onclick="showTab('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
Dashboard
</button>
<button onclick="showTab('campaigns')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
Campaigns
<span class="ml-auto px-2 py-0.5 rounded-full text-xs bg-blue-500" id="campaignCount">-</span>
</button>
<button onclick="showTab('keywords')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
Keywords
</button>
<button onclick="showTab('ads')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
Ads
</button>
<button onclick="showTab('devices')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
Devices
</button>
</nav>

<div class="p-4 border-t border-slate-700/50">
<div class="flex items-center gap-3 px-3 py-2 mb-3">
<img id="userPicture" src="" class="w-8 h-8 rounded-full bg-slate-700">
<div class="flex-1 min-w-0">
<p class="text-sm font-medium truncate" id="userName">User</p>
<p class="text-xs text-slate-400 truncate" id="userEmail">email@example.com</p>
</div>
</div>
<a href="/auth/logout" class="w-full flex items-center gap-3 px-4 py-2 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
Logout
</a>
</div>
</aside>

<!-- Main Content -->
<main class="flex-1 ml-60">
<!-- Header -->
<header class="sticky top-0 z-40 bg-slate-900/90 border-b border-slate-700/50 glass">
<div class="px-6 py-4 flex items-center justify-between">
<div>
<h2 class="text-xl font-bold" id="pageTitle">Dashboard</h2>
<p class="text-sm text-slate-400">Customer ID: <span id="customerId">-</span></p>
</div>
<div class="flex items-center gap-3">
<select id="dateRange" onchange="handleDateRangeChange()" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
<option value="today">Today</option>
<option value="yesterday">Yesterday</option>
<option value="last7">Last 7 Days</option>
<option value="last30" selected>Last 30 Days</option>
<option value="last90">Last 90 Days</option>
<option value="thisMonth">This Month</option>
<option value="lastMonth">Last Month</option>
</select>
<button onclick="refreshData()" class="p-2 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700 transition-colors">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
</button>
</div>
</div>
</header>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center">
<div class="text-center">
<div class="spinner mx-auto mb-4"></div>
<p class="text-slate-400">Loading data from Google Ads...</p>
</div>
</div>

<!-- Error Message -->
<div id="errorMessage" class="hidden mx-6 mt-6 p-4 rounded-xl bg-rose-500/20 border border-rose-500/50 text-rose-400"></div>

<!-- Page Content -->
<div class="p-6" id="content">
<!-- Dashboard Tab -->
<div id="tab-dashboard" class="tab-content">
<!-- KPI Cards -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
<div class="stat-card bg-slate-800/60 border border-slate-700/50 rounded-xl p-4 transition-all">
<div class="flex items-center justify-between mb-2">
<div class="p-2 rounded-lg bg-blue-500/20"><svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></div>
</div>
<p class="text-xs text-slate-400 uppercase tracking-wide">Impressions</p>
<p class="text-2xl font-bold" id="kpiImpressions">-</p>
</div>
<div class="stat-card bg-slate-800/60 border border-slate-700/50 rounded-xl p-4 transition-all">
<div class="flex items-center justify-between mb-2">
<div class="p-2 rounded-lg bg-purple-500/20"><svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg></div>
</div>
<p class="text-xs text-slate-400 uppercase tracking-wide">Clicks</p>
<p class="text-2xl font-bold" id="kpiClicks">-</p>
</div>
<div class="stat-card bg-slate-800/60 border border-slate-700/50 rounded-xl p-4 transition-all">
<div class="flex items-center justify-between mb-2">
<div class="p-2 rounded-lg bg-emerald-500/20"><svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
</div>
<p class="text-xs text-slate-400 uppercase tracking-wide">Conversions</p>
<p class="text-2xl font-bold" id="kpiConversions">-</p>
</div>
<div class="stat-card bg-slate-800/60 border border-slate-700/50 rounded-xl p-4 transition-all">
<div class="flex items-center justify-between mb-2">
<div class="p-2 rounded-lg bg-amber-500/20"><svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
</div>
<p class="text-xs text-slate-400 uppercase tracking-wide">Cost</p>
<p class="text-2xl font-bold" id="kpiCost">-</p>
</div>
<div class="stat-card bg-slate-800/60 border border-slate-700/50 rounded-xl p-4 transition-all">
<div class="flex items-center justify-between mb-2">
<div class="p-2 rounded-lg bg-rose-500/20"><svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg></div>
</div>
<p class="text-xs text-slate-400 uppercase tracking-wide">Revenue</p>
<p class="text-2xl font-bold" id="kpiRevenue">-</p>
</div>
<div class="stat-card bg-slate-800/60 border border-slate-700/50 rounded-xl p-4 transition-all">
<div class="flex items-center justify-between mb-2">
<div class="p-2 rounded-lg bg-cyan-500/20"><svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></div>
</div>
<p class="text-xs text-slate-400 uppercase tracking-wide">ROAS</p>
<p class="text-2xl font-bold" id="kpiRoas">-</p>
</div>
</div>

<!-- Additional KPIs -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl p-4">
<p class="text-xs text-slate-400 uppercase">CTR</p>
<p class="text-xl font-bold" id="kpiCtr">-</p>
</div>
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl p-4">
<p class="text-xs text-slate-400 uppercase">Avg. CPC</p>
<p class="text-xl font-bold" id="kpiCpc">-</p>
</div>
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl p-4">
<p class="text-xs text-slate-400 uppercase">CPA</p>
<p class="text-xl font-bold" id="kpiCpa">-</p>
</div>
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl p-4">
<p class="text-xs text-slate-400 uppercase">Conv. Rate</p>
<p class="text-xl font-bold" id="kpiConvRate">-</p>
</div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
<h3 class="font-semibold mb-4">Performance Trend</h3>
<canvas id="performanceChart" height="120"></canvas>
</div>
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
<h3 class="font-semibold mb-4">Device Distribution</h3>
<canvas id="deviceChart" height="120"></canvas>
</div>
</div>

<!-- Campaigns Table -->
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl overflow-hidden">
<div class="p-4 border-b border-slate-700/50 flex items-center justify-between">
<h3 class="font-semibold">Top Campaigns</h3>
<button onclick="showTab('campaigns')" class="text-sm text-blue-400 hover:text-blue-300">View All →</button>
</div>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead><tr class="text-xs uppercase text-slate-400 bg-slate-800/80">
<th class="text-left p-4">Campaign</th><th class="text-left p-4">Status</th><th class="text-left p-4">Type</th>
<th class="text-right p-4">Impr</th><th class="text-right p-4">Clicks</th><th class="text-right p-4">Conv</th>
<th class="text-right p-4">Cost</th><th class="text-right p-4">ROAS</th>
</tr></thead>
<tbody id="dashboardCampaignsTable"></tbody>
</table>
</div>
</div>
</div>

<!-- Campaigns Tab -->
<div id="tab-campaigns" class="tab-content hidden">
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl overflow-hidden">
<div class="p-4 border-b border-slate-700/50">
<h3 class="font-semibold">All Campaigns</h3>
</div>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead><tr class="text-xs uppercase text-slate-400 bg-slate-800/80">
<th class="text-left p-4">Campaign</th><th class="text-left p-4">Status</th><th class="text-left p-4">Type</th><th class="text-left p-4">Bid Strategy</th>
<th class="text-right p-4">Budget</th><th class="text-right p-4">Impr</th><th class="text-right p-4">Clicks</th><th class="text-right p-4">CTR</th>
<th class="text-right p-4">Conv</th><th class="text-right p-4">Cost</th><th class="text-right p-4">CPA</th><th class="text-right p-4">Revenue</th><th class="text-right p-4">ROAS</th>
</tr></thead>
<tbody id="campaignsTable"></tbody>
</table>
</div>
</div>
</div>

<!-- Keywords Tab -->
<div id="tab-keywords" class="tab-content hidden">
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl overflow-hidden">
<div class="p-4 border-b border-slate-700/50">
<h3 class="font-semibold">Keywords Performance</h3>
</div>
<div class="overflow-x-auto max-h-[600px] overflow-y-auto">
<table class="w-full text-sm">
<thead class="sticky top-0 bg-slate-800"><tr class="text-xs uppercase text-slate-400">
<th class="text-left p-4">Keyword</th><th class="text-left p-4">Match</th><th class="text-left p-4">Status</th><th class="text-center p-4">QS</th>
<th class="text-right p-4">Bid</th><th class="text-right p-4">Impr</th><th class="text-right p-4">Clicks</th><th class="text-right p-4">CTR</th>
<th class="text-right p-4">Conv</th><th class="text-right p-4">Cost</th><th class="text-right p-4">CPA</th>
</tr></thead>
<tbody id="keywordsTable"></tbody>
</table>
</div>
</div>
</div>

<!-- Ads Tab -->
<div id="tab-ads" class="tab-content hidden">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="adsContainer"></div>
</div>

<!-- Devices Tab -->
<div id="tab-devices" class="tab-content hidden">
<div class="bg-slate-800/60 border border-slate-700/50 rounded-xl overflow-hidden">
<div class="p-4 border-b border-slate-700/50">
<h3 class="font-semibold">Device Performance</h3>
</div>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead><tr class="text-xs uppercase text-slate-400 bg-slate-800/80">
<th class="text-left p-4">Device</th><th class="text-right p-4">Impressions</th><th class="text-right p-4">Clicks</th>
<th class="text-right p-4">CTR</th><th class="text-right p-4">Conversions</th><th class="text-right p-4">Cost</th><th class="text-right p-4">CPA</th>
</tr></thead>
<tbody id="devicesTable"></tbody>
</table>
</div>
</div>
</div>

</div>
</main>
</div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
// GLOBAL STATE
// ═══════════════════════════════════════════════════════════
let isAuthenticated = false;
let currentUser = null;
let currentTab = 'dashboard';
let performanceChart = null;
let deviceChart = null;

// ═══════════════════════════════════════════════════════════
// FORMATTING HELPERS
// ═══════════════════════════════════════════════════════════
const fmt = n => {
  if (n === null || n === undefined || isNaN(n)) return '-';
  if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
  if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
  return n.toLocaleString();
};

const fmtC = n => {
  if (n === null || n === undefined || isNaN(n)) return '-';
  return '$'+n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
};

const fmtPct = n => {
  if (n === null || n === undefined || isNaN(n)) return '-';
  return (n * 100).toFixed(2) + '%';
};

const statusBadge = s => {
  const colors = {
    'ENABLED': 'bg-emerald-500/20 text-emerald-400',
    'PAUSED': 'bg-amber-500/20 text-amber-400',
    'REMOVED': 'bg-slate-500/20 text-slate-400',
    'Active': 'bg-emerald-500/20 text-emerald-400',
    'Paused': 'bg-amber-500/20 text-amber-400'
  };
  const label = s === 'ENABLED' ? 'Active' : s === 'PAUSED' ? 'Paused' : s;
  return `<span class="px-2 py-1 rounded-full text-xs font-medium ${colors[s] || 'bg-slate-500/20 text-slate-400'}">${label}</span>`;
};

const qsBadge = q => {
  if (!q) return '<span class="text-slate-500">-</span>';
  const color = q >= 8 ? 'text-emerald-400' : q >= 6 ? 'text-amber-400' : 'text-rose-400';
  return `<span class="font-bold ${color}">${q}/10</span>`;
};

// ═══════════════════════════════════════════════════════════
// API CALLS
// ═══════════════════════════════════════════════════════════
async function checkAuth() {
  try {
    const res = await fetch('/auth/status');
    const data = await res.json();
    
    if (data.authenticated) {
      isAuthenticated = true;
      currentUser = data.user;
      document.getElementById('customerId').textContent = data.customerId || '-';
      showApp();
      loadDashboard();
    } else {
      showLogin();
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    showLogin();
  }
}

async function fetchAPI(endpoint) {
  const range = document.getElementById('dateRange').value;
  const res = await fetch(`/api/${endpoint}?range=${range}`);
  
  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.error || 'API request failed');
  }
  
  return res.json();
}

// ═══════════════════════════════════════════════════════════
// UI FUNCTIONS
// ═══════════════════════════════════════════════════════════
function showLogin() {
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
  
  // Check for error in URL
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('error')) {
    document.getElementById('loginError').classList.remove('hidden');
    document.getElementById('loginError').textContent = 'Authentication failed. Please try again.';
  }
}

function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  
  // Update user info
  if (currentUser) {
    document.getElementById('userName').textContent = currentUser.name || 'User';
    document.getElementById('userEmail').textContent = currentUser.email || '';
    if (currentUser.picture) {
      document.getElementById('userPicture').src = currentUser.picture;
    }
  }
}

function showLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

function showError(message) {
  const el = document.getElementById('errorMessage');
  el.textContent = message;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 10000);
}

function showTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
  document.getElementById('tab-'+tab).classList.remove('hidden');
  
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.remove('active');
    n.classList.add('text-slate-400');
  });
  event.target.closest('.nav-item').classList.add('active');
  event.target.closest('.nav-item').classList.remove('text-slate-400');
  
  const titles = {dashboard:'Dashboard',campaigns:'Campaigns',keywords:'Keywords',ads:'Ads',devices:'Devices'};
  document.getElementById('pageTitle').textContent = titles[tab] || tab;
  
  // Load data for the tab
  loadTabData(tab);
}

function handleDateRangeChange() {
  loadTabData(currentTab);
}

function refreshData() {
  loadTabData(currentTab);
}

// ═══════════════════════════════════════════════════════════
// DATA LOADING
// ═══════════════════════════════════════════════════════════
async function loadTabData(tab) {
  showLoading(true);
  try {
    switch(tab) {
      case 'dashboard': await loadDashboard(); break;
      case 'campaigns': await loadCampaigns(); break;
      case 'keywords': await loadKeywords(); break;
      case 'ads': await loadAds(); break;
      case 'devices': await loadDevices(); break;
    }
  } catch (error) {
    console.error('Error loading data:', error);
    showError(error.message);
  } finally {
    showLoading(false);
  }
}

async function loadDashboard() {
  const data = await fetchAPI('dashboard');
  
  if (data.success) {
    const s = data.data.summary;
    
    // Update KPIs
    document.getElementById('kpiImpressions').textContent = fmt(s.impressions);
    document.getElementById('kpiClicks').textContent = fmt(s.clicks);
    document.getElementById('kpiConversions').textContent = fmt(s.conversions);
    document.getElementById('kpiCost').textContent = fmtC(s.cost);
    document.getElementById('kpiRevenue').textContent = fmtC(s.revenue);
    document.getElementById('kpiRoas').textContent = s.roas ? s.roas.toFixed(2) + 'x' : '-';
    document.getElementById('kpiCtr').textContent = s.ctr ? s.ctr.toFixed(2) + '%' : '-';
    document.getElementById('kpiCpc').textContent = fmtC(s.cpc);
    document.getElementById('kpiCpa').textContent = fmtC(s.cpa);
    document.getElementById('kpiConvRate').textContent = s.clicks > 0 ? ((s.conversions/s.clicks)*100).toFixed(2) + '%' : '-';
    
    // Update campaign count
    document.getElementById('campaignCount').textContent = data.data.campaigns.length;
    
    // Render campaigns table
    renderDashboardCampaigns(data.data.campaigns);
    
    // Render charts
    renderPerformanceChart(s.daily);
    renderDeviceChart(data.data.devices);
  }
}

async function loadCampaigns() {
  const data = await fetchAPI('campaigns');
  
  if (data.success) {
    renderCampaignsTable(data.data);
  }
}

async function loadKeywords() {
  const data = await fetchAPI('keywords');
  
  if (data.success) {
    renderKeywordsTable(data.data);
  }
}

async function loadAds() {
  const data = await fetchAPI('ads');
  
  if (data.success) {
    renderAds(data.data);
  }
}

async function loadDevices() {
  const data = await fetchAPI('devices');
  
  if (data.success) {
    renderDevicesTable(data.data);
  }
}

// ═══════════════════════════════════════════════════════════
// RENDER FUNCTIONS
// ═══════════════════════════════════════════════════════════
function renderDashboardCampaigns(campaigns) {
  const tbody = document.getElementById('dashboardCampaignsTable');
  tbody.innerHTML = campaigns.slice(0, 10).map(c => `
    <tr class="table-row border-t border-slate-700/50">
      <td class="p-4"><p class="font-medium">${c.name}</p></td>
      <td class="p-4">${statusBadge(c.status)}</td>
      <td class="p-4 text-slate-400">${c.type}</td>
      <td class="p-4 text-right text-slate-300">${fmt(c.impressions)}</td>
      <td class="p-4 text-right text-slate-300">${fmt(c.clicks)}</td>
      <td class="p-4 text-right font-medium">${fmt(c.conversions)}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(c.cost)}</td>
      <td class="p-4 text-right font-medium ${c.cost > 0 && c.revenue/c.cost >= 3 ? 'text-emerald-400' : c.cost > 0 && c.revenue/c.cost >= 2 ? 'text-amber-400' : 'text-rose-400'}">${c.cost > 0 ? (c.revenue/c.cost).toFixed(2)+'x' : '-'}</td>
    </tr>
  `).join('');
}

function renderCampaignsTable(campaigns) {
  const tbody = document.getElementById('campaignsTable');
  tbody.innerHTML = campaigns.map(c => `
    <tr class="table-row border-t border-slate-700/50">
      <td class="p-4"><p class="font-medium">${c.name}</p></td>
      <td class="p-4">${statusBadge(c.status)}</td>
      <td class="p-4 text-slate-400">${c.type}</td>
      <td class="p-4 text-slate-400">${c.bidStrategy}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(c.budget)}/d</td>
      <td class="p-4 text-right text-slate-300">${fmt(c.impressions)}</td>
      <td class="p-4 text-right text-slate-300">${fmt(c.clicks)}</td>
      <td class="p-4 text-right text-slate-300">${fmtPct(c.ctr)}</td>
      <td class="p-4 text-right font-medium">${fmt(c.conversions)}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(c.cost)}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(c.cpa)}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(c.revenue)}</td>
      <td class="p-4 text-right font-medium ${c.cost > 0 && c.revenue/c.cost >= 3 ? 'text-emerald-400' : c.cost > 0 && c.revenue/c.cost >= 2 ? 'text-amber-400' : 'text-rose-400'}">${c.cost > 0 ? (c.revenue/c.cost).toFixed(2)+'x' : '-'}</td>
    </tr>
  `).join('');
}

function renderKeywordsTable(keywords) {
  const tbody = document.getElementById('keywordsTable');
  tbody.innerHTML = keywords.map(k => `
    <tr class="table-row border-t border-slate-700/50">
      <td class="p-4 font-medium">${k.keyword}</td>
      <td class="p-4"><span class="px-2 py-0.5 rounded text-xs ${k.matchType==='Exact'?'bg-blue-500/20 text-blue-400':k.matchType==='Phrase'?'bg-purple-500/20 text-purple-400':'bg-amber-500/20 text-amber-400'}">${k.matchType}</span></td>
      <td class="p-4">${statusBadge(k.status)}</td>
      <td class="p-4 text-center">${qsBadge(k.qualityScore)}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(k.bid)}</td>
      <td class="p-4 text-right text-slate-300">${fmt(k.impressions)}</td>
      <td class="p-4 text-right text-slate-300">${fmt(k.clicks)}</td>
      <td class="p-4 text-right text-slate-300">${fmtPct(k.ctr)}</td>
      <td class="p-4 text-right font-medium">${fmt(k.conversions)}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(k.cost)}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(k.cpa)}</td>
    </tr>
  `).join('');
}

function renderAds(ads) {
  const container = document.getElementById('adsContainer');
  container.innerHTML = ads.map(a => `
    <div class="bg-slate-800/60 border border-slate-700/50 rounded-xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded text-xs bg-blue-500/20 text-blue-400">${a.type}</span>
          ${statusBadge(a.status)}
        </div>
        <span class="px-2 py-0.5 rounded text-xs ${a.adStrength==='EXCELLENT'?'bg-emerald-500/20 text-emerald-400':a.adStrength==='GOOD'?'bg-blue-500/20 text-blue-400':'bg-amber-500/20 text-amber-400'}">${a.adStrength}</span>
      </div>
      <div class="p-3 rounded-lg bg-slate-700/50 mb-3">
        <p class="text-blue-400 text-sm font-medium mb-1">${a.headlines[0] || 'No headline'}</p>
        <p class="text-xs text-slate-400">${a.descriptions[0] || 'No description'}</p>
        <p class="text-emerald-400 text-xs mt-1">${a.finalUrl ? new URL(a.finalUrl).hostname : '-'}</p>
      </div>
      <div class="grid grid-cols-4 gap-2 text-center">
        <div><p class="text-xs text-slate-500">Impr</p><p class="text-sm font-bold">${fmt(a.impressions)}</p></div>
        <div><p class="text-xs text-slate-500">Clicks</p><p class="text-sm font-bold">${fmt(a.clicks)}</p></div>
        <div><p class="text-xs text-slate-500">CTR</p><p class="text-sm font-bold">${fmtPct(a.ctr)}</p></div>
        <div><p class="text-xs text-slate-500">Conv</p><p class="text-sm font-bold">${fmt(a.conversions)}</p></div>
      </div>
    </div>
  `).join('');
}

function renderDevicesTable(devices) {
  const tbody = document.getElementById('devicesTable');
  tbody.innerHTML = devices.map(d => `
    <tr class="table-row border-t border-slate-700/50">
      <td class="p-4 font-medium">${d.device}</td>
      <td class="p-4 text-right text-slate-300">${fmt(d.impressions)}</td>
      <td class="p-4 text-right text-slate-300">${fmt(d.clicks)}</td>
      <td class="p-4 text-right text-slate-300">${d.impressions > 0 ? ((d.clicks/d.impressions)*100).toFixed(2)+'%' : '-'}</td>
      <td class="p-4 text-right font-medium">${fmt(d.conversions)}</td>
      <td class="p-4 text-right text-slate-300">${fmtC(d.cost)}</td>
      <td class="p-4 text-right text-slate-300">${d.conversions > 0 ? fmtC(d.cost/d.conversions) : '-'}</td>
    </tr>
  `).join('');
}

// ═══════════════════════════════════════════════════════════
// CHARTS
// ═══════════════════════════════════════════════════════════
function renderPerformanceChart(daily) {
  const ctx = document.getElementById('performanceChart').getContext('2d');
  
  if (performanceChart) performanceChart.destroy();
  
  const labels = daily.map(d => d.date).reverse();
  const data = daily.map(d => d.conversions).reverse();
  
  performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Conversions',
        data,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59,130,246,0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#334155' }, ticks: { color: '#64748b', maxTicksLimit: 10 } },
        y: { grid: { color: '#334155' }, ticks: { color: '#64748b' } }
      }
    }
  });
}

function renderDeviceChart(devices) {
  const ctx = document.getElementById('deviceChart').getContext('2d');
  
  if (deviceChart) deviceChart.destroy();
  
  const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f97316'];
  
  deviceChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: devices.map(d => d.device),
      datasets: [{
        data: devices.map(d => d.impressions),
        backgroundColor: colors,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right', labels: { color: '#94a3b8' } }
      },
      cutout: '60%'
    }
  });
}

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', checkAuth);
</script>
</body>
</html>
